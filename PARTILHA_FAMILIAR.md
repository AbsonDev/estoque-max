# üè† **Partilha Familiar de Despensas** - EstoqueMax

## üìã **Resumo da Funcionalidade**

A **Partilha Familiar** √© uma funcionalidade colaborativa que permite aos usu√°rios compartilhar suas despensas com outros membros da fam√≠lia. Esta funcionalidade transforma o EstoqueMax de uma ferramenta pessoal em uma plataforma colaborativa para gest√£o dom√©stica.

## üéØ **Problema Resolvido**

**Antes:** "Eu organizo o EstoqueMax, mas sou a √∫nica que atualiza. O meu marido consome produtos e n√£o d√° baixa, o que torna a lista de compras imprecisa."

**Depois:** Com a partilha familiar, todos os membros da fam√≠lia podem colaborar na gest√£o das despensas, mantendo o estoque sempre atualizado e a lista de compras precisa.

## üîß **Funcionalidades Implementadas**

### **1. Sistema de Convites**
- Donos de despensas podem convidar outros usu√°rios por email
- Sistema de convites pendentes, aceitos e recusados
- Notifica√ß√µes de convites recebidos

### **2. Gest√£o de Membros**
- **Dono**: Usu√°rio que criou a despensa (pode convidar/remover membros)
- **Membro**: Usu√°rio convidado (pode ver e gerenciar itens)
- Controle de permiss√µes centralizado

### **3. Acesso Compartilhado**
- Todos os membros podem ver e gerenciar itens da despensa
- Atualiza√ß√µes em tempo real refletem para todos os membros
- Lista de compras colaborativa

## üöÄ **Endpoints da API**

### **DespensasController**
```http
GET /api/despensas
# Retorna todas as despensas que o usu√°rio tem acesso (como dono ou membro)

POST /api/despensas/{id}/convidar
# Convida um usu√°rio para ser membro da despensa (apenas dono)
Body: { "emailDestinatario": "email@exemplo.com", "mensagem": "Venha gerenciar nossa despensa!" }

DELETE /api/despensas/{id}/membros/{membroId}
# Remove um membro da despensa (apenas dono)
```

### **ConvitesController**
```http
GET /api/convites
# Lista convites recebidos pelo usu√°rio

PUT /api/convites/{id}/aceitar
# Aceita um convite (torna-se membro da despensa)

PUT /api/convites/{id}/recusar
# Recusa um convite

GET /api/convites/enviados
# Lista convites enviados pelo usu√°rio
```

### **EstoqueController (Atualizado)**
```http
GET /api/estoque?despensaId={id}
# Lista itens de uma despensa espec√≠fica (se tiver permiss√£o)

POST /api/estoque
# Adiciona item ao estoque (verifica√ß√£o de permiss√£o)

PUT /api/estoque/{id}
# Atualiza item do estoque (verifica√ß√£o de permiss√£o)

DELETE /api/estoque/{id}
# Remove item do estoque (verifica√ß√£o de permiss√£o)
```

## üóÑÔ∏è **Estrutura de Dados**

### **Tabela: MembrosDespensa**
```sql
CREATE TABLE "MembrosDespensa" (
    "UsuarioId" integer NOT NULL,
    "DespensaId" integer NOT NULL,
    "Papel" integer NOT NULL, -- 0=Dono, 1=Membro
    "DataAcesso" timestamp with time zone NOT NULL,
    CONSTRAINT "PK_MembrosDespensa" PRIMARY KEY ("UsuarioId", "DespensaId")
);
```

### **Tabela: ConvitesDespensa**
```sql
CREATE TABLE "ConvitesDespensa" (
    "Id" integer GENERATED BY DEFAULT AS IDENTITY,
    "DespensaId" integer NOT NULL,
    "RemetenteId" integer NOT NULL,
    "DestinatarioId" integer NOT NULL,
    "Estado" integer NOT NULL, -- 0=Pendente, 1=Aceite, 2=Recusado
    "DataEnvio" timestamp with time zone NOT NULL,
    "DataResposta" timestamp with time zone,
    "Mensagem" text,
    CONSTRAINT "PK_ConvitesDespensa" PRIMARY KEY ("Id")
);
```

## üîê **Sistema de Permiss√µes**

### **IPermissionService**
```csharp
public interface IPermissionService
{
    Task<bool> PodeAcederDespensa(int usuarioId, int despensaId);
    Task<bool> IsDonoDespensa(int usuarioId, int despensaId);
    Task<int[]> GetDespensasDoUsuario(int usuarioId);
    Task<bool> PodeConvidarParaDespensa(int usuarioId, int despensaId);
    Task<bool> PodeRemoverMembroDespensa(int usuarioId, int despensaId, int membroId);
}
```

### **Regras de Neg√≥cio**
- **Dono**: Pode convidar membros, remover membros, alterar nome da despensa, deletar despensa
- **Membro**: Pode ver itens, adicionar itens, consumir itens, atualizar itens, remover itens
- **Seguran√ßa**: Todas as opera√ß√µes verificam permiss√µes antes de executar

## üìä **Impacto no Neg√≥cio**

### **Valor Entregue**
- **Efeito de Rede**: Cada usu√°rio pode trazer mais pessoas para a plataforma
- **Engajamento**: Utilidade da aplica√ß√£o cresce exponencialmente com cada membro
- **Reten√ß√£o**: Fam√≠lias inteiras ficam dependentes da plataforma
- **Diferencia√ß√£o**: Transforma ferramenta pessoal em plataforma colaborativa

### **Casos de Uso Reais**
1. **Casal**: Ambos podem atualizar o estoque da cozinha
2. **Fam√≠lia**: Filhos podem marcar quando consomem produtos
3. **Apartamento Compartilhado**: Colegas de casa gerenciam despensa comum
4. **Casas M√∫ltiplas**: Gerenciar despensas de casa principal e casa de campo

## üß™ **Fluxo de Teste**

### **Cen√°rio 1: Convite e Aceita√ß√£o**
1. Ana cria despensa "Cozinha"
2. Ana convida Jo√£o: `POST /api/despensas/1/convidar`
3. Jo√£o visualiza convite: `GET /api/convites`
4. Jo√£o aceita convite: `PUT /api/convites/1/aceitar`
5. Jo√£o agora v√™ a despensa: `GET /api/despensas`

### **Cen√°rio 2: Colabora√ß√£o**
1. Ana adiciona "Leite" na despensa: `POST /api/estoque`
2. Jo√£o consome leite: `POST /api/estoque/1/consumir`
3. Sistema adiciona "Leite" √† lista de compras automaticamente
4. Ana v√™ o leite na lista de compras: `GET /api/listadecompras`

## üîÑ **Migration Segura**

A implementa√ß√£o incluiu uma migration cuidadosa que:
1. Criou as novas tabelas (`MembrosDespensa`, `ConvitesDespensa`)
2. Migrou dados existentes (donos atuais viraram donos na nova estrutura)
3. Removeu a estrutura antiga sem perda de dados
4. Preservou 100% dos dados existentes

## üéØ **Pr√≥ximos Passos**

1. **Frontend**: Implementar interfaces para gest√£o de convites
2. **Notifica√ß√µes**: Sistema de notifica√ß√µes em tempo real
3. **Relat√≥rios**: Dashboards de atividade familiar
4. **Integra√ß√£o**: Parcerias com supermercados para compras colaborativas

---

**Status:** ‚úÖ **Completo e Funcional**  
**Commit:** `ddadcfd` - "Implementar Partilha Familiar de Despensas"  
**Arquivos Alterados:** 27 arquivos (+1,327 linhas)  
**Impacto:** Transforma√ß√£o de ferramenta pessoal em plataforma colaborativa 